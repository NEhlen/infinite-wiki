{% extends "base.html" %}

{% block title %}{{ article.title }} - Infinite Wiki{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center;">
    <h2>{{ article.title }}</h2>
    <a href="/world/{{ world_name }}/wiki/{{ article.title }}/edit" class="button"
        style="font-size: 0.8em; padding: 5px 10px; background-color: #007bff; color: white; text-decoration: none; border-radius: 4px;">Edit</a>
</div>

{% if article.image_url %}
<div class="image-container">
    <img src="{{ article.image_url }}" alt="{{ article.image_caption }}">
    <p class="caption">{{ article.image_caption }}</p>
</div>
{% elif generate_images %}
<div class="image-container" id="image-placeholder">
    <div class="loading-image">
        <p>Generating Image...</p>
        <div class="spinner"></div>
    </div>
    <p class="caption">{{ article.image_caption }}</p>
</div>
<script>
    // Poll for image
    const checkImage = setInterval(() => {
        fetch(window.location.href)
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const img = doc.querySelector('.image-container img');
                if (img) {
                    document.querySelector('.image-container').innerHTML = doc.querySelector('.image-container').innerHTML;
                    clearInterval(checkImage);
                }
            });
    }, 3000);
</script>
{% endif %}

<div class="summary">
    <strong>Summary:</strong> {{ article.summary }}
</div>

<hr>

<div class="content">
    {{ content_html | safe }}
</div>

<div class="related">
    <h3>Related Entries</h3>
    <ul>
        {% for entity in related_entities %}
        <li>
            <a href="/world/{{ world_name }}/wiki/{{ entity.name }}" onclick="showLoading()">{{ entity.name }}</a>
            <span style="font-size: 0.8em; color: #666;">({{ entity.type }})</span>
        </li>
        {% endfor %}
    </ul>
</div>

<div id="loading-msg" class="loading">
    Generating content for the next entry... This might take a moment.
</div>

<!-- Select-to-Generate Feature -->
<button id="generate-btn" class="generate-btn" style="display: none;">
    <span class="icon">âœ¨</span> Generate Article
</button>

<style>
    .generate-btn {
        position: absolute;
        z-index: 1000;
        background: #2c3e50;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        transition: transform 0.2s, opacity 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
        pointer-events: auto;
    }

    .generate-btn:hover {
        background: #34495e;
        transform: translateY(-2px);
    }

    .generate-btn .icon {
        font-size: 16px;
    }

    /* Mobile Styles */
    @media (max-width: 768px) {
        .generate-btn.mobile-visible {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            justify-content: center;
            padding: 12px 20px;
            font-size: 16px;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                transform: translate(-50%, 100%);
                opacity: 0;
            }

            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const btn = document.getElementById('generate-btn');
        const contentArea = document.querySelector('.content');
        let isSelecting = false;

        // Handle selection changes
        document.addEventListener('selectionchange', () => {
            const selection = window.getSelection();
            const text = selection.toString().trim();

            // Hide if no text or selection is outside content area
            if (!text || !contentArea.contains(selection.anchorNode)) {
                hideButton();
                return;
            }

            // Show button
            showButton(selection);
        });

        function showButton(selection) {
            const range = selection.getRangeAt(0);
            const rect = range.getBoundingClientRect();
            const isMobile = window.innerWidth <= 768;

            btn.style.display = 'flex';

            if (isMobile) {
                btn.classList.add('mobile-visible');
                btn.style.top = 'auto';
                btn.style.left = '50%';
            } else {
                btn.classList.remove('mobile-visible');
                // Position above the selection
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                btn.style.top = `${rect.top + scrollTop - 45}px`;
                btn.style.left = `${rect.left + (rect.width / 2) - (btn.offsetWidth / 2)}px`;
            }
        }

        function hideButton() {
            btn.style.display = 'none';
            btn.classList.remove('mobile-visible');
        }

        // Handle click
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();

            const selection = window.getSelection();
            const text = selection.toString().trim();

            if (text) {
                // Clean text: remove non-alphanumeric chars from ends, limit length
                const cleanText = text.replace(/^[^a-zA-Z0-9]+|[^a-zA-Z0-9]+$/g, '');
                if (cleanText) {
                    // Show loading state
                    btn.innerHTML = '<span class="spinner" style="width:16px;height:16px;border:2px solid #fff;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;"></span> Generating...';

                    // Navigate
                    window.location.href = `/world/{{ world_name }}/wiki/${encodeURIComponent(cleanText)}?skip-validation=false`;
                }
            }
        });

        // Add spin animation if not present
        if (!document.getElementById('spin-style')) {
            const style = document.createElement('style');
            style.id = 'spin-style';
            style.textContent = '@keyframes spin { to { transform: rotate(360deg); } }';
            document.head.appendChild(style);
        }
    });
</script>
{% endblock %}