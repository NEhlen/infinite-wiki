<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Visualizers - {{ world_name }}</title>
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <script type="text/javascript"
        src="https://unpkg.com/vis-timeline/standalone/umd/vis-timeline-graph2d.min.js"></script>
    <link href="https://unpkg.com/vis-timeline/styles/vis-timeline-graph2d.min.css" rel="stylesheet" type="text/css" />
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 20px;
            background: #f4f4f4;
        }

        header {
            background: #333;
            color: #fff;
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        a {
            color: #fff;
            text-decoration: none;
            margin-left: 10px;
        }

        .container {
            background: #fff;
            padding: 1rem;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            height: 80vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            /* Prevent expansion */
        }

        .tabs {
            margin-bottom: 1rem;
            flex-shrink: 0;
            /* Don't shrink tabs */
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background: #eee;
            border: none;
            border-radius: 5px 5px 0 0;
        }

        .tab.active {
            background: #fff;
            font-weight: bold;
            border-bottom: 2px solid #333;
        }

        .view {
            display: none;
            flex-grow: 1;
            border: 1px solid #ddd;
            position: relative;
            /* For absolute children if needed */
            height: 100%;
            /* Ensure it takes full height */
            overflow: hidden;
        }

        .view.active {
            display: block;
        }

        #mynetwork {
            width: 100%;
            height: 100%;
            position: absolute;
            /* Force fit */
            top: 0;
            left: 0;
        }

        #mytimeline {
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>
    <header>
        <h1>Visualizers: {{ world_name }}</h1>
        <div>
            <a href="/world/{{ world_name }}">Back to World</a>
        </div>
    </header>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="openTab('graph')">Knowledge Graph</button>
            <button class="tab" onclick="openTab('timeline')">Timeline</button>
        </div>

        <div id="graph" class="view active">
            <div id="mynetwork"></div>
        </div>

        <div id="timeline" class="view">
            <div id="mytimeline"></div>
        </div>
    </div>

    <script type="text/javascript">
        const worldName = "{{ world_name }}";

        function openTab(tabName) {
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // --- Graph ---
        async function loadGraph() {
            const response = await fetch(`/api/world/${worldName}/graph_data`);
            const data = await response.json();

            const nodes = new vis.DataSet(data.nodes.map(n => ({
                id: n.id,
                label: n.id,
                group: n.type,
                title: JSON.stringify(n, null, 2) // Tooltip
            })));

            const edges = new vis.DataSet(data.links.map(l => ({
                from: l.source,
                to: l.target,
                label: l.relation,
                arrows: 'to'
            })));

            const container = document.getElementById('mynetwork');
            const networkData = { nodes: nodes, edges: edges };
            const options = {
                nodes: {
                    shape: 'dot',
                    size: 15,
                    font: { size: 14, color: '#000' },
                    borderWidth: 2
                },
                edges: {
                    width: 1,
                    color: { inherit: 'from' },
                    smooth: { type: 'continuous' }
                },
                physics: {
                    stabilization: true,
                    barnesHut: {
                        gravitationalConstant: -8000,
                        springConstant: 0.04,
                        springLength: 95
                    }
                },
                layout: {
                    improvedLayout: true
                }
            };
            new vis.Network(container, networkData, options);
        }

        // --- Timeline ---
        async function loadTimeline() {
            const response = await fetch(`/api/world/${worldName}/timeline_data`);
            const data = await response.json();

            // Parse dates? Vis.js handles strings like "2024" well.
            // If we have "Era of X", it might fail. We might need to map to numbers or use 'point' type.

            const items = new vis.DataSet(data);
            const container = document.getElementById('mytimeline');
            const options = {
                height: '100%',
                start: '2100-01-01', // Default view
                end: '2200-01-01'
            };
            new vis.Timeline(container, items, options);
        }

        loadGraph();
        loadTimeline();
    </script>
</body>

</html>